<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - PostgreSQL 13devel - src/bin/pg_dump/pg_backup_db.c</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">src/bin/pg_dump</a> - pg_backup_db.c<span style="font-size: 80%;"> (source / <a href="pg_backup_db.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">PostgreSQL 13devel</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">255</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2019-11-27 09:34:56</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">18</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*-------------------------------------------------------------------------</a>
<span class="lineNum">       2 </span>            :  *
<span class="lineNum">       3 </span>            :  * pg_backup_db.c
<span class="lineNum">       4 </span>            :  *
<span class="lineNum">       5 </span>            :  *  Implements the basic DB functions used by the archiver.
<span class="lineNum">       6 </span>            :  *
<span class="lineNum">       7 </span>            :  * IDENTIFICATION
<span class="lineNum">       8 </span>            :  *    src/bin/pg_dump/pg_backup_db.c
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *-------------------------------------------------------------------------
<span class="lineNum">      11 </span>            :  */
<span class="lineNum">      12 </span>            : #include &quot;postgres_fe.h&quot;
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      15 </span>            : #include &lt;ctype.h&gt;
<span class="lineNum">      16 </span>            : #ifdef HAVE_TERMIOS_H
<span class="lineNum">      17 </span>            : #include &lt;termios.h&gt;
<span class="lineNum">      18 </span>            : #endif
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : #include &quot;dumputils.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;fe_utils/connect.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;fe_utils/string_utils.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;parallel.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;pg_backup_archiver.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;pg_backup_db.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;pg_backup_utils.h&quot;
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : static void _check_database_version(ArchiveHandle *AH);
<span class="lineNum">      29 </span>            : static PGconn *_connectDB(ArchiveHandle *AH, const char *newdbname, const char *newUser);
<span class="lineNum">      30 </span>            : static void notice_processor(void *arg, const char *message);
<a name="31"><span class="lineNum">      31 </span>            : </a>
<span class="lineNum">      32 </span>            : static void
<span class="lineNum">      33 </span><span class="lineNoCov">          0 : _check_database_version(ArchiveHandle *AH)</span>
<span class="lineNum">      34 </span>            : {
<span class="lineNum">      35 </span>            :     const char *remoteversion_str;
<span class="lineNum">      36 </span>            :     int         remoteversion;
<span class="lineNum">      37 </span>            :     PGresult   *res;
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span><span class="lineNoCov">          0 :     remoteversion_str = PQparameterStatus(AH-&gt;connection, &quot;server_version&quot;);</span>
<span class="lineNum">      40 </span><span class="lineNoCov">          0 :     remoteversion = PQserverVersion(AH-&gt;connection);</span>
<span class="lineNum">      41 </span><span class="lineNoCov">          0 :     if (remoteversion == 0 || !remoteversion_str)</span>
<span class="lineNum">      42 </span><span class="lineNoCov">          0 :         fatal(&quot;could not get server_version from libpq&quot;);</span>
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span><span class="lineNoCov">          0 :     AH-&gt;public.remoteVersionStr = pg_strdup(remoteversion_str);</span>
<span class="lineNum">      45 </span><span class="lineNoCov">          0 :     AH-&gt;public.remoteVersion = remoteversion;</span>
<span class="lineNum">      46 </span><span class="lineNoCov">          0 :     if (!AH-&gt;archiveRemoteVersion)</span>
<span class="lineNum">      47 </span><span class="lineNoCov">          0 :         AH-&gt;archiveRemoteVersion = AH-&gt;public.remoteVersionStr;</span>
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :     if (remoteversion != PG_VERSION_NUM</span>
<span class="lineNum">      50 </span><span class="lineNoCov">          0 :         &amp;&amp; (remoteversion &lt; AH-&gt;public.minRemoteVersion ||</span>
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :             remoteversion &gt; AH-&gt;public.maxRemoteVersion))</span>
<span class="lineNum">      52 </span>            :     {
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :         pg_log_error(&quot;server version: %s; %s version: %s&quot;,</span>
<span class="lineNum">      54 </span>            :                      remoteversion_str, progname, PG_VERSION);
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :         fatal(&quot;aborting because of server version mismatch&quot;);</span>
<span class="lineNum">      56 </span>            :     }
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            :     /*
<span class="lineNum">      59 </span>            :      * When running against 9.0 or later, check if we are in recovery mode,
<span class="lineNum">      60 </span>            :      * which means we are on a hot standby.
<span class="lineNum">      61 </span>            :      */
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :     if (remoteversion &gt;= 90000)</span>
<span class="lineNum">      63 </span>            :     {
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :         res = ExecuteSqlQueryForSingleRow((Archive *) AH, &quot;SELECT pg_catalog.pg_is_in_recovery()&quot;);</span>
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :         AH-&gt;public.isStandby = (strcmp(PQgetvalue(res, 0, 0), &quot;t&quot;) == 0);</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :         PQclear(res);</span>
<span class="lineNum">      68 </span>            :     }
<span class="lineNum">      69 </span>            :     else
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :         AH-&gt;public.isStandby = false;</span>
<span class="lineNum">      71 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span>            : /*
<span class="lineNum">      74 </span>            :  * Reconnect to the server.  If dbname is not NULL, use that database,
<span class="lineNum">      75 </span>            :  * else the one associated with the archive handle.  If username is
<span class="lineNum">      76 </span>            :  * not NULL, use that user name, else the one from the handle.
<a name="77"><span class="lineNum">      77 </span>            :  */</a>
<span class="lineNum">      78 </span>            : void
<span class="lineNum">      79 </span><span class="lineNoCov">          0 : ReconnectToServer(ArchiveHandle *AH, const char *dbname, const char *username)</span>
<span class="lineNum">      80 </span>            : {
<span class="lineNum">      81 </span>            :     PGconn     *newConn;
<span class="lineNum">      82 </span>            :     const char *newdbname;
<span class="lineNum">      83 </span>            :     const char *newusername;
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :     if (!dbname)</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :         newdbname = PQdb(AH-&gt;connection);</span>
<span class="lineNum">      87 </span>            :     else
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :         newdbname = dbname;</span>
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :     if (!username)</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :         newusername = PQuser(AH-&gt;connection);</span>
<span class="lineNum">      92 </span>            :     else
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :         newusername = username;</span>
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :     newConn = _connectDB(AH, newdbname, newusername);</span>
<span class="lineNum">      96 </span>            : 
<span class="lineNum">      97 </span>            :     /* Update ArchiveHandle's connCancel before closing old connection */
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :     set_archive_cancel_info(AH, newConn);</span>
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :     PQfinish(AH-&gt;connection);</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :     AH-&gt;connection = newConn;</span>
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span>            :     /* Start strict; later phases may override this. */
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :     PQclear(ExecuteSqlQueryForSingleRow((Archive *) AH,</span>
<span class="lineNum">     105 </span>            :                                         ALWAYS_SECURE_SEARCH_PATH_SQL));
<span class="lineNum">     106 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span>            : /*
<span class="lineNum">     109 </span>            :  * Connect to the db again.
<span class="lineNum">     110 </span>            :  *
<span class="lineNum">     111 </span>            :  * Note: it's not really all that sensible to use a single-entry password
<span class="lineNum">     112 </span>            :  * cache if the username keeps changing.  In current usage, however, the
<span class="lineNum">     113 </span>            :  * username never does change, so one savedPassword is sufficient.  We do
<span class="lineNum">     114 </span>            :  * update the cache on the off chance that the password has changed since the
<span class="lineNum">     115 </span>            :  * start of the run.
<a name="116"><span class="lineNum">     116 </span>            :  */</a>
<span class="lineNum">     117 </span>            : static PGconn *
<span class="lineNum">     118 </span><span class="lineNoCov">          0 : _connectDB(ArchiveHandle *AH, const char *reqdb, const char *requser)</span>
<span class="lineNum">     119 </span>            : {
<span class="lineNum">     120 </span>            :     PQExpBufferData connstr;
<span class="lineNum">     121 </span>            :     PGconn     *newConn;
<span class="lineNum">     122 </span>            :     const char *newdb;
<span class="lineNum">     123 </span>            :     const char *newuser;
<span class="lineNum">     124 </span>            :     char       *password;
<span class="lineNum">     125 </span>            :     char        passbuf[100];
<span class="lineNum">     126 </span>            :     bool        new_pass;
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     if (!reqdb)</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :         newdb = PQdb(AH-&gt;connection);</span>
<span class="lineNum">     130 </span>            :     else
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :         newdb = reqdb;</span>
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :     if (!requser || strlen(requser) == 0)</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :         newuser = PQuser(AH-&gt;connection);</span>
<span class="lineNum">     135 </span>            :     else
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :         newuser = requser;</span>
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :     pg_log_info(&quot;connecting to database \&quot;%s\&quot; as user \&quot;%s\&quot;&quot;,</span>
<span class="lineNum">     139 </span>            :                 newdb, newuser);
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :     password = AH-&gt;savedPassword;</span>
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :     if (AH-&gt;promptPassword == TRI_YES &amp;&amp; password == NULL)</span>
<span class="lineNum">     144 </span>            :     {
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :         simple_prompt(&quot;Password: &quot;, passbuf, sizeof(passbuf), false);</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :         password = passbuf;</span>
<span class="lineNum">     147 </span>            :     }
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     initPQExpBuffer(&amp;connstr);</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :     appendPQExpBufferStr(&amp;connstr, &quot;dbname=&quot;);</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :     appendConnStrVal(&amp;connstr, newdb);</span>
<span class="lineNum">     152 </span>            : 
<span class="lineNum">     153 </span>            :     do
<span class="lineNum">     154 </span>            :     {
<span class="lineNum">     155 </span>            :         const char *keywords[7];
<span class="lineNum">     156 </span>            :         const char *values[7];
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :         keywords[0] = &quot;host&quot;;</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :         values[0] = PQhost(AH-&gt;connection);</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :         keywords[1] = &quot;port&quot;;</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :         values[1] = PQport(AH-&gt;connection);</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :         keywords[2] = &quot;user&quot;;</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :         values[2] = newuser;</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :         keywords[3] = &quot;password&quot;;</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :         values[3] = password;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :         keywords[4] = &quot;dbname&quot;;</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :         values[4] = connstr.data;</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :         keywords[5] = &quot;fallback_application_name&quot;;</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :         values[5] = progname;</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :         keywords[6] = NULL;</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :         values[6] = NULL;</span>
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :         new_pass = false;</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :         newConn = PQconnectdbParams(keywords, values, true);</span>
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :         if (!newConn)</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :             fatal(&quot;could not reconnect to database&quot;);</span>
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :         if (PQstatus(newConn) == CONNECTION_BAD)</span>
<span class="lineNum">     180 </span>            :         {
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :             if (!PQconnectionNeedsPassword(newConn))</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :                 fatal(&quot;could not reconnect to database: %s&quot;,</span>
<span class="lineNum">     183 </span>            :                       PQerrorMessage(newConn));
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :             PQfinish(newConn);</span>
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :             if (password)</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :                 fprintf(stderr, &quot;Password incorrect\n&quot;);</span>
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :             fprintf(stderr, &quot;Connecting to %s as %s\n&quot;,</span>
<span class="lineNum">     190 </span>            :                     newdb, newuser);
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :             if (AH-&gt;promptPassword != TRI_NO)</span>
<span class="lineNum">     193 </span>            :             {
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :                 simple_prompt(&quot;Password: &quot;, passbuf, sizeof(passbuf), false);</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :                 password = passbuf;</span>
<span class="lineNum">     196 </span>            :             }
<span class="lineNum">     197 </span>            :             else
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :                 fatal(&quot;connection needs password&quot;);</span>
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :             new_pass = true;</span>
<span class="lineNum">     201 </span>            :         }
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :     } while (new_pass);</span>
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span>            :     /*
<span class="lineNum">     205 </span>            :      * We want to remember connection's actual password, whether or not we got
<span class="lineNum">     206 </span>            :      * it by prompting.  So we don't just store the password variable.
<span class="lineNum">     207 </span>            :      */
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :     if (PQconnectionUsedPassword(newConn))</span>
<span class="lineNum">     209 </span>            :     {
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :         if (AH-&gt;savedPassword)</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :             free(AH-&gt;savedPassword);</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :         AH-&gt;savedPassword = pg_strdup(PQpass(newConn));</span>
<span class="lineNum">     213 </span>            :     }
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :     termPQExpBuffer(&amp;connstr);</span>
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span>            :     /* check for version mismatch */
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :     _check_database_version(AH);</span>
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :     PQsetNoticeProcessor(newConn, notice_processor, NULL);</span>
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :     return newConn;</span>
<span class="lineNum">     223 </span>            : }
<span class="lineNum">     224 </span>            : 
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span>            : /*
<span class="lineNum">     227 </span>            :  * Make a database connection with the given parameters.  The
<span class="lineNum">     228 </span>            :  * connection handle is returned, the parameters are stored in AHX.
<span class="lineNum">     229 </span>            :  * An interactive password prompt is automatically issued if required.
<span class="lineNum">     230 </span>            :  *
<span class="lineNum">     231 </span>            :  * Note: it's not really all that sensible to use a single-entry password
<span class="lineNum">     232 </span>            :  * cache if the username keeps changing.  In current usage, however, the
<span class="lineNum">     233 </span>            :  * username never does change, so one savedPassword is sufficient.
<a name="234"><span class="lineNum">     234 </span>            :  */</a>
<span class="lineNum">     235 </span>            : void
<span class="lineNum">     236 </span><span class="lineNoCov">          0 : ConnectDatabase(Archive *AHX,</span>
<span class="lineNum">     237 </span>            :                 const char *dbname,
<span class="lineNum">     238 </span>            :                 const char *pghost,
<span class="lineNum">     239 </span>            :                 const char *pgport,
<span class="lineNum">     240 </span>            :                 const char *username,
<span class="lineNum">     241 </span>            :                 trivalue prompt_password)
<span class="lineNum">     242 </span>            : {
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :     ArchiveHandle *AH = (ArchiveHandle *) AHX;</span>
<span class="lineNum">     244 </span>            :     char       *password;
<span class="lineNum">     245 </span>            :     char        passbuf[100];
<span class="lineNum">     246 </span>            :     bool        new_pass;
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :     if (AH-&gt;connection)</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :         fatal(&quot;already connected to a database&quot;);</span>
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :     password = AH-&gt;savedPassword;</span>
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :     if (prompt_password == TRI_YES &amp;&amp; password == NULL)</span>
<span class="lineNum">     254 </span>            :     {
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :         simple_prompt(&quot;Password: &quot;, passbuf, sizeof(passbuf), false);</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :         password = passbuf;</span>
<span class="lineNum">     257 </span>            :     }
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :     AH-&gt;promptPassword = prompt_password;</span>
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span>            :     /*
<span class="lineNum">     261 </span>            :      * Start the connection.  Loop until we have a password if requested by
<span class="lineNum">     262 </span>            :      * backend.
<span class="lineNum">     263 </span>            :      */
<span class="lineNum">     264 </span>            :     do
<span class="lineNum">     265 </span>            :     {
<span class="lineNum">     266 </span>            :         const char *keywords[7];
<span class="lineNum">     267 </span>            :         const char *values[7];
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :         keywords[0] = &quot;host&quot;;</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :         values[0] = pghost;</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :         keywords[1] = &quot;port&quot;;</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :         values[1] = pgport;</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         keywords[2] = &quot;user&quot;;</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :         values[2] = username;</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :         keywords[3] = &quot;password&quot;;</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :         values[3] = password;</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :         keywords[4] = &quot;dbname&quot;;</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :         values[4] = dbname;</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :         keywords[5] = &quot;fallback_application_name&quot;;</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :         values[5] = progname;</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :         keywords[6] = NULL;</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :         values[6] = NULL;</span>
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :         new_pass = false;</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         AH-&gt;connection = PQconnectdbParams(keywords, values, true);</span>
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :         if (!AH-&gt;connection)</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :             fatal(&quot;could not connect to database&quot;);</span>
<span class="lineNum">     289 </span>            : 
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :         if (PQstatus(AH-&gt;connection) == CONNECTION_BAD &amp;&amp;</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :             PQconnectionNeedsPassword(AH-&gt;connection) &amp;&amp;</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :             password == NULL &amp;&amp;</span>
<span class="lineNum">     293 </span>            :             prompt_password != TRI_NO)
<span class="lineNum">     294 </span>            :         {
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :             PQfinish(AH-&gt;connection);</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :             simple_prompt(&quot;Password: &quot;, passbuf, sizeof(passbuf), false);</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :             password = passbuf;</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :             new_pass = true;</span>
<span class="lineNum">     299 </span>            :         }
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :     } while (new_pass);</span>
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span>            :     /* check to see that the backend connection was successfully made */
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :     if (PQstatus(AH-&gt;connection) == CONNECTION_BAD)</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :         fatal(&quot;connection to database \&quot;%s\&quot; failed: %s&quot;,</span>
<span class="lineNum">     305 </span>            :               PQdb(AH-&gt;connection) ? PQdb(AH-&gt;connection) : &quot;&quot;,
<span class="lineNum">     306 </span>            :               PQerrorMessage(AH-&gt;connection));
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span>            :     /* Start strict; later phases may override this. */
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :     PQclear(ExecuteSqlQueryForSingleRow((Archive *) AH,</span>
<span class="lineNum">     310 </span>            :                                         ALWAYS_SECURE_SEARCH_PATH_SQL));
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span>            :     /*
<span class="lineNum">     313 </span>            :      * We want to remember connection's actual password, whether or not we got
<span class="lineNum">     314 </span>            :      * it by prompting.  So we don't just store the password variable.
<span class="lineNum">     315 </span>            :      */
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :     if (PQconnectionUsedPassword(AH-&gt;connection))</span>
<span class="lineNum">     317 </span>            :     {
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :         if (AH-&gt;savedPassword)</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :             free(AH-&gt;savedPassword);</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :         AH-&gt;savedPassword = pg_strdup(PQpass(AH-&gt;connection));</span>
<span class="lineNum">     321 </span>            :     }
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span>            :     /* check for version mismatch */
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :     _check_database_version(AH);</span>
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :     PQsetNoticeProcessor(AH-&gt;connection, notice_processor, NULL);</span>
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span>            :     /* arrange for SIGINT to issue a query cancel on this connection */
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :     set_archive_cancel_info(AH, AH-&gt;connection);</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     331 </span>            : 
<span class="lineNum">     332 </span>            : /*
<span class="lineNum">     333 </span>            :  * Close the connection to the database and also cancel off the query if we
<span class="lineNum">     334 </span>            :  * have one running.
<a name="335"><span class="lineNum">     335 </span>            :  */</a>
<span class="lineNum">     336 </span>            : void
<span class="lineNum">     337 </span><span class="lineNoCov">          0 : DisconnectDatabase(Archive *AHX)</span>
<span class="lineNum">     338 </span>            : {
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :     ArchiveHandle *AH = (ArchiveHandle *) AHX;</span>
<span class="lineNum">     340 </span>            :     char        errbuf[1];
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :     if (!AH-&gt;connection)</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     344 </span>            : 
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     if (AH-&gt;connCancel)</span>
<span class="lineNum">     346 </span>            :     {
<span class="lineNum">     347 </span>            :         /*
<span class="lineNum">     348 </span>            :          * If we have an active query, send a cancel before closing, ignoring
<span class="lineNum">     349 </span>            :          * any errors.  This is of no use for a normal exit, but might be
<span class="lineNum">     350 </span>            :          * helpful during fatal().
<span class="lineNum">     351 </span>            :          */
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :         if (PQtransactionStatus(AH-&gt;connection) == PQTRANS_ACTIVE)</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :             (void) PQcancel(AH-&gt;connCancel, errbuf, sizeof(errbuf));</span>
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span>            :         /*
<span class="lineNum">     356 </span>            :          * Prevent signal handler from sending a cancel after this.
<span class="lineNum">     357 </span>            :          */
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :         set_archive_cancel_info(AH, NULL);</span>
<span class="lineNum">     359 </span>            :     }
<span class="lineNum">     360 </span>            : 
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :     PQfinish(AH-&gt;connection);</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :     AH-&gt;connection = NULL;</span>
<span class="lineNum">     363 </span>            : }
<a name="364"><span class="lineNum">     364 </span>            : </a>
<span class="lineNum">     365 </span>            : PGconn *
<span class="lineNum">     366 </span><span class="lineNoCov">          0 : GetConnection(Archive *AHX)</span>
<span class="lineNum">     367 </span>            : {
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :     ArchiveHandle *AH = (ArchiveHandle *) AHX;</span>
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :     return AH-&gt;connection;</span>
<span class="lineNum">     371 </span>            : }
<a name="372"><span class="lineNum">     372 </span>            : </a>
<span class="lineNum">     373 </span>            : static void
<span class="lineNum">     374 </span><span class="lineNoCov">          0 : notice_processor(void *arg, const char *message)</span>
<span class="lineNum">     375 </span>            : {
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     pg_log_generic(PG_LOG_INFO, &quot;%s&quot;, message);</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     378 </span>            : 
<a name="379"><span class="lineNum">     379 </span>            : /* Like fatal(), but with a complaint about a particular query. */</a>
<span class="lineNum">     380 </span>            : static void
<span class="lineNum">     381 </span><span class="lineNoCov">          0 : die_on_query_failure(ArchiveHandle *AH, const char *query)</span>
<span class="lineNum">     382 </span>            : {
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :     pg_log_error(&quot;query failed: %s&quot;,</span>
<span class="lineNum">     384 </span>            :                  PQerrorMessage(AH-&gt;connection));
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :     fatal(&quot;query was: %s&quot;, query);</span>
<span class="lineNum">     386 </span>            : }
<a name="387"><span class="lineNum">     387 </span>            : </a>
<span class="lineNum">     388 </span>            : void
<span class="lineNum">     389 </span><span class="lineNoCov">          0 : ExecuteSqlStatement(Archive *AHX, const char *query)</span>
<span class="lineNum">     390 </span>            : {
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     ArchiveHandle *AH = (ArchiveHandle *) AHX;</span>
<span class="lineNum">     392 </span>            :     PGresult   *res;
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :     res = PQexec(AH-&gt;connection, query);</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     if (PQresultStatus(res) != PGRES_COMMAND_OK)</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :         die_on_query_failure(AH, query);</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     PQclear(res);</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 : }</span>
<a name="399"><span class="lineNum">     399 </span>            : </a>
<span class="lineNum">     400 </span>            : PGresult *
<span class="lineNum">     401 </span><span class="lineNoCov">          0 : ExecuteSqlQuery(Archive *AHX, const char *query, ExecStatusType status)</span>
<span class="lineNum">     402 </span>            : {
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :     ArchiveHandle *AH = (ArchiveHandle *) AHX;</span>
<span class="lineNum">     404 </span>            :     PGresult   *res;
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :     res = PQexec(AH-&gt;connection, query);</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :     if (PQresultStatus(res) != status)</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :         die_on_query_failure(AH, query);</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :     return res;</span>
<span class="lineNum">     410 </span>            : }
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span>            : /*
<span class="lineNum">     413 </span>            :  * Execute an SQL query and verify that we got exactly one row back.
<a name="414"><span class="lineNum">     414 </span>            :  */</a>
<span class="lineNum">     415 </span>            : PGresult *
<span class="lineNum">     416 </span><span class="lineNoCov">          0 : ExecuteSqlQueryForSingleRow(Archive *fout, const char *query)</span>
<span class="lineNum">     417 </span>            : {
<span class="lineNum">     418 </span>            :     PGresult   *res;
<span class="lineNum">     419 </span>            :     int         ntups;
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :     res = ExecuteSqlQuery(fout, query, PGRES_TUPLES_OK);</span>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span>            :     /* Expecting a single result only */
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :     ntups = PQntuples(res);</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :     if (ntups != 1)</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :         fatal(ngettext(&quot;query returned %d row instead of one: %s&quot;,</span>
<span class="lineNum">     427 </span>            :                        &quot;query returned %d rows instead of one: %s&quot;,
<span class="lineNum">     428 </span>            :                        ntups),
<span class="lineNum">     429 </span>            :               ntups, query);
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :     return res;</span>
<span class="lineNum">     432 </span>            : }
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span>            : /*
<span class="lineNum">     435 </span>            :  * Convenience function to send a query.
<span class="lineNum">     436 </span>            :  * Monitors result to detect COPY statements
<a name="437"><span class="lineNum">     437 </span>            :  */</a>
<span class="lineNum">     438 </span>            : static void
<span class="lineNum">     439 </span><span class="lineNoCov">          0 : ExecuteSqlCommand(ArchiveHandle *AH, const char *qry, const char *desc)</span>
<span class="lineNum">     440 </span>            : {
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :     PGconn     *conn = AH-&gt;connection;</span>
<span class="lineNum">     442 </span>            :     PGresult   *res;
<span class="lineNum">     443 </span>            : 
<span class="lineNum">     444 </span>            : #ifdef NOT_USED
<span class="lineNum">     445 </span>            :     fprintf(stderr, &quot;Executing: '%s'\n\n&quot;, qry);
<span class="lineNum">     446 </span>            : #endif
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :     res = PQexec(conn, qry);</span>
<span class="lineNum">     448 </span>            : 
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :     switch (PQresultStatus(res))</span>
<span class="lineNum">     450 </span>            :     {
<span class="lineNum">     451 </span>            :         case PGRES_COMMAND_OK:
<span class="lineNum">     452 </span>            :         case PGRES_TUPLES_OK:
<span class="lineNum">     453 </span>            :         case PGRES_EMPTY_QUERY:
<span class="lineNum">     454 </span>            :             /* A-OK */
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     456 </span>            :         case PGRES_COPY_IN:
<span class="lineNum">     457 </span>            :             /* Assume this is an expected result */
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :             AH-&gt;pgCopyIn = true;</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     460 </span>            :         default:
<span class="lineNum">     461 </span>            :             /* trouble */
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :             warn_or_exit_horribly(AH, &quot;%s: %sCommand was: %s&quot;,</span>
<span class="lineNum">     463 </span>            :                                   desc, PQerrorMessage(conn), qry);
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     465 </span>            :     }
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     PQclear(res);</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span>            : /*
<span class="lineNum">     472 </span>            :  * Process non-COPY table data (that is, INSERT commands).
<span class="lineNum">     473 </span>            :  *
<span class="lineNum">     474 </span>            :  * The commands have been run together as one long string for compressibility,
<span class="lineNum">     475 </span>            :  * and we are receiving them in bufferloads with arbitrary boundaries, so we
<span class="lineNum">     476 </span>            :  * have to locate command boundaries and save partial commands across calls.
<span class="lineNum">     477 </span>            :  * All state must be kept in AH-&gt;sqlparse, not in local variables of this
<span class="lineNum">     478 </span>            :  * routine.  We assume that AH-&gt;sqlparse was filled with zeroes when created.
<span class="lineNum">     479 </span>            :  *
<span class="lineNum">     480 </span>            :  * We have to lex the data to the extent of identifying literals and quoted
<span class="lineNum">     481 </span>            :  * identifiers, so that we can recognize statement-terminating semicolons.
<span class="lineNum">     482 </span>            :  * We assume that INSERT data will not contain SQL comments, E'' literals,
<span class="lineNum">     483 </span>            :  * or dollar-quoted strings, so this is much simpler than a full SQL lexer.
<span class="lineNum">     484 </span>            :  *
<span class="lineNum">     485 </span>            :  * Note: when restoring from a pre-9.0 dump file, this code is also used to
<span class="lineNum">     486 </span>            :  * process BLOB COMMENTS data, which has the same problem of containing
<span class="lineNum">     487 </span>            :  * multiple SQL commands that might be split across bufferloads.  Fortunately,
<span class="lineNum">     488 </span>            :  * that data won't contain anything complicated to lex either.
<a name="489"><span class="lineNum">     489 </span>            :  */</a>
<span class="lineNum">     490 </span>            : static void
<span class="lineNum">     491 </span><span class="lineNoCov">          0 : ExecuteSimpleCommands(ArchiveHandle *AH, const char *buf, size_t bufLen)</span>
<span class="lineNum">     492 </span>            : {
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :     const char *qry = buf;</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :     const char *eos = buf + bufLen;</span>
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span>            :     /* initialize command buffer if first time through */
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :     if (AH-&gt;sqlparse.curCmd == NULL)</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :         AH-&gt;sqlparse.curCmd = createPQExpBuffer();</span>
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :     for (; qry &lt; eos; qry++)</span>
<span class="lineNum">     501 </span>            :     {
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :         char        ch = *qry;</span>
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span>            :         /* For neatness, we skip any newlines between commands */
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :         if (!(ch == '\n' &amp;&amp; AH-&gt;sqlparse.curCmd-&gt;len == 0))</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :             appendPQExpBufferChar(AH-&gt;sqlparse.curCmd, ch);</span>
<span class="lineNum">     507 </span>            : 
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :         switch (AH-&gt;sqlparse.state)</span>
<span class="lineNum">     509 </span>            :         {
<span class="lineNum">     510 </span>            :             case SQL_SCAN:      /* Default state == 0, set in _allocAH */
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :                 if (ch == ';')</span>
<span class="lineNum">     512 </span>            :                 {
<span class="lineNum">     513 </span>            :                     /*
<span class="lineNum">     514 </span>            :                      * We've found the end of a statement. Send it and reset
<span class="lineNum">     515 </span>            :                      * the buffer.
<span class="lineNum">     516 </span>            :                      */
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :                     ExecuteSqlCommand(AH, AH-&gt;sqlparse.curCmd-&gt;data,</span>
<span class="lineNum">     518 </span>            :                                       &quot;could not execute query&quot;);
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :                     resetPQExpBuffer(AH-&gt;sqlparse.curCmd);</span>
<span class="lineNum">     520 </span>            :                 }
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                 else if (ch == '\'')</span>
<span class="lineNum">     522 </span>            :                 {
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :                     AH-&gt;sqlparse.state = SQL_IN_SINGLE_QUOTE;</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :                     AH-&gt;sqlparse.backSlash = false;</span>
<span class="lineNum">     525 </span>            :                 }
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :                 else if (ch == '&quot;')</span>
<span class="lineNum">     527 </span>            :                 {
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :                     AH-&gt;sqlparse.state = SQL_IN_DOUBLE_QUOTE;</span>
<span class="lineNum">     529 </span>            :                 }
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span>            :             case SQL_IN_SINGLE_QUOTE:
<span class="lineNum">     533 </span>            :                 /* We needn't handle '' specially */
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :                 if (ch == '\'' &amp;&amp; !AH-&gt;sqlparse.backSlash)</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :                     AH-&gt;sqlparse.state = SQL_SCAN;</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :                 else if (ch == '\\' &amp;&amp; !AH-&gt;public.std_strings)</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :                     AH-&gt;sqlparse.backSlash = !AH-&gt;sqlparse.backSlash;</span>
<span class="lineNum">     538 </span>            :                 else
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :                     AH-&gt;sqlparse.backSlash = false;</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span>            :             case SQL_IN_DOUBLE_QUOTE:
<span class="lineNum">     543 </span>            :                 /* We needn't handle &quot;&quot; specially */
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :                 if (ch == '&quot;')</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :                     AH-&gt;sqlparse.state = SQL_SCAN;</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     547 </span>            :         }
<span class="lineNum">     548 </span>            :     }
<span class="lineNum">     549 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span>            : 
<span class="lineNum">     552 </span>            : /*
<span class="lineNum">     553 </span>            :  * Implement ahwrite() for direct-to-DB restore
<a name="554"><span class="lineNum">     554 </span>            :  */</a>
<span class="lineNum">     555 </span>            : int
<span class="lineNum">     556 </span><span class="lineNoCov">          0 : ExecuteSqlCommandBuf(Archive *AHX, const char *buf, size_t bufLen)</span>
<span class="lineNum">     557 </span>            : {
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :     ArchiveHandle *AH = (ArchiveHandle *) AHX;</span>
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :     if (AH-&gt;outputKind == OUTPUT_COPYDATA)</span>
<span class="lineNum">     561 </span>            :     {
<span class="lineNum">     562 </span>            :         /*
<span class="lineNum">     563 </span>            :          * COPY data.
<span class="lineNum">     564 </span>            :          *
<span class="lineNum">     565 </span>            :          * We drop the data on the floor if libpq has failed to enter COPY
<span class="lineNum">     566 </span>            :          * mode; this allows us to behave reasonably when trying to continue
<span class="lineNum">     567 </span>            :          * after an error in a COPY command.
<span class="lineNum">     568 </span>            :          */
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :         if (AH-&gt;pgCopyIn &amp;&amp;</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :             PQputCopyData(AH-&gt;connection, buf, bufLen) &lt;= 0)</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :             fatal(&quot;error returned by PQputCopyData: %s&quot;,</span>
<span class="lineNum">     572 </span>            :                   PQerrorMessage(AH-&gt;connection));
<span class="lineNum">     573 </span>            :     }
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :     else if (AH-&gt;outputKind == OUTPUT_OTHERDATA)</span>
<span class="lineNum">     575 </span>            :     {
<span class="lineNum">     576 </span>            :         /*
<span class="lineNum">     577 </span>            :          * Table data expressed as INSERT commands; or, in old dump files,
<span class="lineNum">     578 </span>            :          * BLOB COMMENTS data (which is expressed as COMMENT ON commands).
<span class="lineNum">     579 </span>            :          */
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :         ExecuteSimpleCommands(AH, buf, bufLen);</span>
<span class="lineNum">     581 </span>            :     }
<span class="lineNum">     582 </span>            :     else
<span class="lineNum">     583 </span>            :     {
<span class="lineNum">     584 </span>            :         /*
<span class="lineNum">     585 </span>            :          * General SQL commands; we assume that commands will not be split
<span class="lineNum">     586 </span>            :          * across calls.
<span class="lineNum">     587 </span>            :          *
<span class="lineNum">     588 </span>            :          * In most cases the data passed to us will be a null-terminated
<span class="lineNum">     589 </span>            :          * string, but if it's not, we have to add a trailing null.
<span class="lineNum">     590 </span>            :          */
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :         if (buf[bufLen] == '\0')</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :             ExecuteSqlCommand(AH, buf, &quot;could not execute query&quot;);</span>
<span class="lineNum">     593 </span>            :         else
<span class="lineNum">     594 </span>            :         {
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :             char       *str = (char *) pg_malloc(bufLen + 1);</span>
<span class="lineNum">     596 </span>            : 
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :             memcpy(str, buf, bufLen);</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :             str[bufLen] = '\0';</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :             ExecuteSqlCommand(AH, str, &quot;could not execute query&quot;);</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :             free(str);</span>
<span class="lineNum">     601 </span>            :         }
<span class="lineNum">     602 </span>            :     }
<span class="lineNum">     603 </span>            : 
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :     return bufLen;</span>
<span class="lineNum">     605 </span>            : }
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span>            : /*
<span class="lineNum">     608 </span>            :  * Terminate a COPY operation during direct-to-DB restore
<a name="609"><span class="lineNum">     609 </span>            :  */</a>
<span class="lineNum">     610 </span>            : void
<span class="lineNum">     611 </span><span class="lineNoCov">          0 : EndDBCopyMode(Archive *AHX, const char *tocEntryTag)</span>
<span class="lineNum">     612 </span>            : {
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :     ArchiveHandle *AH = (ArchiveHandle *) AHX;</span>
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :     if (AH-&gt;pgCopyIn)</span>
<span class="lineNum">     616 </span>            :     {
<span class="lineNum">     617 </span>            :         PGresult   *res;
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :         if (PQputCopyEnd(AH-&gt;connection, NULL) &lt;= 0)</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :             fatal(&quot;error returned by PQputCopyEnd: %s&quot;,</span>
<span class="lineNum">     621 </span>            :                   PQerrorMessage(AH-&gt;connection));
<span class="lineNum">     622 </span>            : 
<span class="lineNum">     623 </span>            :         /* Check command status and return to normal libpq state */
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :         res = PQgetResult(AH-&gt;connection);</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :         if (PQresultStatus(res) != PGRES_COMMAND_OK)</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :             warn_or_exit_horribly(AH, &quot;COPY failed for table \&quot;%s\&quot;: %s&quot;,</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :                                   tocEntryTag, PQerrorMessage(AH-&gt;connection));</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :         PQclear(res);</span>
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span>            :         /* Do this to ensure we've pumped libpq back to idle state */
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :         if (PQgetResult(AH-&gt;connection) != NULL)</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :             pg_log_warning(&quot;unexpected extra results during COPY of table \&quot;%s\&quot;&quot;,</span>
<span class="lineNum">     633 </span>            :                            tocEntryTag);
<span class="lineNum">     634 </span>            : 
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :         AH-&gt;pgCopyIn = false;</span>
<span class="lineNum">     636 </span>            :     }
<span class="lineNum">     637 </span><span class="lineNoCov">          0 : }</span>
<a name="638"><span class="lineNum">     638 </span>            : </a>
<span class="lineNum">     639 </span>            : void
<span class="lineNum">     640 </span><span class="lineNoCov">          0 : StartTransaction(Archive *AHX)</span>
<span class="lineNum">     641 </span>            : {
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :     ArchiveHandle *AH = (ArchiveHandle *) AHX;</span>
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :     ExecuteSqlCommand(AH, &quot;BEGIN&quot;, &quot;could not start database transaction&quot;);</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 : }</span>
<a name="646"><span class="lineNum">     646 </span>            : </a>
<span class="lineNum">     647 </span>            : void
<span class="lineNum">     648 </span><span class="lineNoCov">          0 : CommitTransaction(Archive *AHX)</span>
<span class="lineNum">     649 </span>            : {
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :     ArchiveHandle *AH = (ArchiveHandle *) AHX;</span>
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :     ExecuteSqlCommand(AH, &quot;COMMIT&quot;, &quot;could not commit database transaction&quot;);</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 : }</span>
<a name="654"><span class="lineNum">     654 </span>            : </a>
<span class="lineNum">     655 </span>            : void
<span class="lineNum">     656 </span><span class="lineNoCov">          0 : DropBlobIfExists(ArchiveHandle *AH, Oid oid)</span>
<span class="lineNum">     657 </span>            : {
<span class="lineNum">     658 </span>            :     /*
<span class="lineNum">     659 </span>            :      * If we are not restoring to a direct database connection, we have to
<span class="lineNum">     660 </span>            :      * guess about how to detect whether the blob exists.  Assume new-style.
<span class="lineNum">     661 </span>            :      */
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :     if (AH-&gt;connection == NULL ||</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :         PQserverVersion(AH-&gt;connection) &gt;= 90000)</span>
<span class="lineNum">     664 </span>            :     {
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :         ahprintf(AH,</span>
<span class="lineNum">     666 </span>            :                  &quot;SELECT pg_catalog.lo_unlink(oid) &quot;
<span class="lineNum">     667 </span>            :                  &quot;FROM pg_catalog.pg_largeobject_metadata &quot;
<span class="lineNum">     668 </span>            :                  &quot;WHERE oid = '%u';\n&quot;,
<span class="lineNum">     669 </span>            :                  oid);
<span class="lineNum">     670 </span>            :     }
<span class="lineNum">     671 </span>            :     else
<span class="lineNum">     672 </span>            :     {
<span class="lineNum">     673 </span>            :         /* Restoring to pre-9.0 server, so do it the old way */
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :         ahprintf(AH,</span>
<span class="lineNum">     675 </span>            :                  &quot;SELECT CASE WHEN EXISTS(&quot;
<span class="lineNum">     676 </span>            :                  &quot;SELECT 1 FROM pg_catalog.pg_largeobject WHERE loid = '%u'&quot;
<span class="lineNum">     677 </span>            :                  &quot;) THEN pg_catalog.lo_unlink('%u') END;\n&quot;,
<span class="lineNum">     678 </span>            :                  oid, oid);
<span class="lineNum">     679 </span>            :     }
<span class="lineNum">     680 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
